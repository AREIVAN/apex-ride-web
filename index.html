<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>APEX RIDE — Web Prototype</title>

  <!-- Leaflet (Map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#070A10;
      --panel:#0B1020;
      --panel2:#0C142A;
      --stroke:rgba(122,63,255,.55);
      --neon:#7A3FFF;
      --neon2:#2FE6FF;
      --hot:#FF2E88;
      --text:#EAF0FF;
      --muted:rgba(234,240,255,.65);
      --good:#2FE6FF;
      --warn:#FFB020;
      --bad:#FF2E88;
      --r:16px;
      --shadow: 0 0 24px rgba(122,63,255,.18), 0 0 18px rgba(47,230,255,.10);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: radial-gradient(1200px 800px at 15% 20%, rgba(122,63,255,.14), transparent 60%),
                  radial-gradient(900px 600px at 80% 10%, rgba(47,230,255,.12), transparent 55%),
                  radial-gradient(1000px 700px at 60% 90%, rgba(255,46,136,.10), transparent 55%),
                  var(--bg);
    }
    .app{
      display:grid;
      grid-template-columns: 380px 1fr;
      min-height:100vh;
      gap:16px;
      padding:16px;
    }
    @media (max-width: 980px){
      .app{grid-template-columns: 1fr; grid-template-rows:auto 1fr}
    }
    .panel{
      background: linear-gradient(180deg, rgba(11,16,32,.92), rgba(12,20,42,.86));
      border:1px solid rgba(122,63,255,.25);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .left{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .topbar{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(122,63,255,.18);
      background: rgba(6,10,18,.55);
    }
    .brand{
      display:flex; gap:10px; align-items:center;
      letter-spacing:.12em;
      font-weight:800;
    }
    .logo{
      width:34px; height:34px;
      border-radius: 10px;
      background: linear-gradient(135deg, rgba(122,63,255,.9), rgba(47,230,255,.7));
      box-shadow: 0 0 18px rgba(122,63,255,.25), 0 0 12px rgba(47,230,255,.18);
      display:grid; place-items:center;
      font-weight:900;
    }
    .chip{
      border:1px solid rgba(47,230,255,.35);
      padding:6px 10px;
      border-radius:999px;
      color:var(--neon2);
      font-weight:700;
      font-size:12px;
      background: rgba(47,230,255,.06);
    }
    .hud{
      padding:16px;
      display:grid;
      gap:12px;
    }
    .speedCard{
      padding:16px;
      border-radius: var(--r);
      border:1px solid rgba(122,63,255,.22);
      background: linear-gradient(180deg, rgba(7,10,16,.55), rgba(8,12,22,.35));
      position:relative;
      overflow:hidden;
    }
    .speedCard:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(600px 120px at 20% 10%, rgba(47,230,255,.12), transparent 60%),
                  radial-gradient(500px 200px at 90% 10%, rgba(122,63,255,.16), transparent 55%),
                  radial-gradient(700px 200px at 50% 120%, rgba(255,46,136,.10), transparent 60%);
      pointer-events:none;
    }
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px; position:relative}
    .label{font-size:12px; color:var(--muted); letter-spacing:.08em; text-transform:uppercase}
    .valueBig{
      font-size:64px;
      font-weight:900;
      line-height:1;
      letter-spacing:-.02em;
      text-shadow: 0 0 18px rgba(47,230,255,.15);
    }
    .unit{
      font-size:16px; font-weight:800; color:var(--muted); letter-spacing:.18em;
      margin-left:8px;
    }
    .kpis{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    .kpi{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(122,63,255,.18);
      background: rgba(6,10,18,.35);
    }
    .kpi .k{font-size:11px; color:var(--muted); letter-spacing:.10em; text-transform:uppercase}
    .kpi .v{margin-top:6px; font-size:16px; font-weight:800}
    .actions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    button{
      appearance:none;
      border:1px solid rgba(122,63,255,.40);
      background: linear-gradient(180deg, rgba(122,63,255,.18), rgba(122,63,255,.06));
      color:var(--text);
      padding:12px 12px;
      border-radius: 14px;
      font-weight:800;
      cursor:pointer;
      box-shadow: 0 0 18px rgba(122,63,255,.12);
      transition: transform .06s ease, border-color .12s ease;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-size:12px;
    }
    button:hover{border-color: rgba(47,230,255,.55)}
    button:active{transform: translateY(1px)}
    button.primary{
      border-color: rgba(47,230,255,.55);
      background: linear-gradient(180deg, rgba(47,230,255,.18), rgba(47,230,255,.05));
    }
    button.danger{
      border-color: rgba(255,46,136,.60);
      background: linear-gradient(180deg, rgba(255,46,136,.18), rgba(255,46,136,.05));
    }
    button:disabled{opacity:.5; cursor:not-allowed}

    .statusLine{
      display:flex; gap:10px; flex-wrap:wrap;
      padding:0 16px 12px 16px;
      color:var(--muted);
      font-size:12px;
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(122,63,255,.20);
      background: rgba(6,10,18,.35);
    }
    .pill.good{border-color: rgba(47,230,255,.35); color: var(--neon2)}
    .pill.bad{border-color: rgba(255,46,136,.45); color: var(--hot)}
    .list{
      padding:14px 16px 16px 16px;
      border-top:1px solid rgba(122,63,255,.18);
      max-height: 380px;
      overflow:auto;
    }
    .list h3{
      margin:0 0 10px 0;
      font-size:12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .rideItem{
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(122,63,255,.18);
      background: rgba(6,10,18,.28);
      display:grid;
      gap:6px;
      margin-bottom:10px;
      cursor:pointer;
    }
    .rideItem:hover{border-color: rgba(47,230,255,.45)}
    .rideItem .t{font-weight:900}
    .rideItem .m{color:var(--muted); font-size:12px}

    #map{
      width:100%;
      height: calc(100vh - 32px);
      min-height: 520px;
      border-radius: var(--r);
      border:1px solid rgba(122,63,255,.25);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .mapWrap{position:relative}
    .mapOverlay{
      position:absolute;
      top:14px; left:14px;
      display:flex; gap:8px; flex-wrap:wrap;
      z-index: 1000;
    }
    .badge{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(47,230,255,.35);
      background: rgba(6,10,18,.55);
      font-size:12px;
      color: var(--neon2);
      box-shadow: 0 0 14px rgba(47,230,255,.10);
      backdrop-filter: blur(6px);
    }

    .smallBtn {
      padding:8px 10px;
      border-radius:12px;
      font-size:11px;
    }
    hr.soft{
      border:none;
      border-top:1px solid rgba(122,63,255,.18);
      margin:10px 0;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="left">
      <div class="panel">
        <div class="topbar">
          <div class="brand">
            <div class="logo">A</div>
            <div>
              <div style="font-size:12px; color:var(--muted); letter-spacing:.18em; font-weight:800;">APEX</div>
              <div style="font-size:14px; font-weight:900; letter-spacing:.08em;">RIDE</div>
            </div>
          </div>
          <div class="chip" id="vehicleChip">MOTO</div>
        </div>

        <div class="hud">
          <div class="speedCard">
            <div class="row" style="margin-bottom:8px;">
              <div class="label">LIVE SPEED</div>
              <div class="label" id="gpsLabel">GPS: —</div>
            </div>
            <div class="row" style="align-items:baseline;">
              <div class="valueBig"><span id="speedNow">0</span><span class="unit">KM/H</span></div>
            </div>
            <div class="row" style="margin-top:10px;">
              <div class="label">MAX</div>
              <div style="font-weight:900;"><span id="speedMax">0</span> <span style="color:var(--muted); font-weight:800;">KM/H</span></div>
            </div>
          </div>

          <div class="kpis">
            <div class="kpi">
              <div class="k">TIME</div>
              <div class="v" id="timeVal">00:00</div>
            </div>
            <div class="kpi">
              <div class="k">DIST</div>
              <div class="v" id="distVal">0.00 km</div>
            </div>
            <div class="kpi">
              <div class="k">AVG</div>
              <div class="v" id="avgVal">0 km/h</div>
            </div>
            <div class="kpi">
              <div class="k">POINTS</div>
              <div class="v" id="ptsVal">0</div>
            </div>
          </div>

          <div class="actions">
            <button class="primary" id="btnStart">START RIDE</button>
            <button class="danger" id="btnStop" disabled>STOP</button>
          </div>
          <div class="actions">
            <button id="btnCenter">CENTER</button>
            <button id="btnClear">CLEAR MAP</button>
          </div>

          <div class="statusLine">
            <div class="pill good" id="pillStatus">READY</div>
            <div class="pill" id="pillAcc">ACC: —</div>
            <div class="pill" id="pillMode">MODE: WEB DEMO</div>
          </div>

          <div class="list">
            <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
              <button id="tabRides" class="primary" style="flex:1;">RIDES</button>
              <button id="tabSegments" style="flex:1;">SEGMENTS</button>
            </div>

            <div id="panelRides">
              <h3>Rides (local)</h3>
              <div id="ridesList"></div>
            </div>

            <div id="panelSegments" style="display:none;">
              <h3>Segments (local)</h3>

              <div class="actions" style="margin-bottom:10px;">
                <button id="btnCreateSegment" class="primary">CREATE SEGMENT</button>
                <button id="btnCancelSegment">CANCEL</button>
              </div>

              <div style="color:rgba(234,240,255,.65); font-size:12px; margin-bottom:10px;" id="segmentHint">
                Tip: CREATE SEGMENT → click Start en el mapa → click End en el mapa.
              </div>

              <div id="segmentsList"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="mapWrap">
      <div id="map"></div>
      <div class="mapOverlay">
        <div class="badge" id="badgeHint">Tip: Usa HTTPS o localhost para GPS.</div>
        <div class="badge" id="badgeRec">REC: OFF</div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ---------- Utilities ----------
    function toRad(x){ return x * Math.PI / 180; }
    function haversineMeters(a,b){
      const R = 6371000;
      const dLat = toRad(b.lat - a.lat);
      const dLon = toRad(b.lng - a.lng);
      const lat1 = toRad(a.lat), lat2 = toRad(b.lat);
      const s = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
      return 2 * R * Math.asin(Math.sqrt(s));
    }
    function fmtTime(sec){
      const m = Math.floor(sec/60);
      const s = Math.floor(sec%60);
      return String(m).padStart(2,'0') + ":" + String(s).padStart(2,'0');
    }
    function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

    // ---------- State ----------
    const STORAGE_KEY = "apex_ride_web_rides_v1";
    let rides = loadRides();

    // Segments storage
    const SEGMENTS_KEY = "apex_ride_web_segments_v1";
    let segments = loadSegments();
    let activeTab = "rides";

    // Segment creation state
    let creatingSegment = false;
    let createStage = 0; // 0=none, 1=waiting start, 2=waiting end
    let segStart = null;
    let segEnd = null;

    let recording = false;
    let watchId = null;
    let startTs = null;
    let lastPoint = null;
    let points = [];
    let distM = 0;
    let maxKmh = 0;
    let timerId = null;
    let polyline = null;
    let marker = null;

    let segStartMarker = null;
    let segEndMarker = null;

    const mockUser = { uid: "local_user", name: "AREIVAN" };

    // ---------- Map ----------
    const map = L.map('map', { zoomControl: true }).setView([19.4326, -99.1332], 12); // CDMX default
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    polyline = L.polyline([], { weight: 4, opacity: 0.95 }).addTo(map);

    // ---------- UI refs ----------
    const elSpeedNow = document.getElementById("speedNow");
    const elSpeedMax = document.getElementById("speedMax");
    const elTime = document.getElementById("timeVal");
    const elDist = document.getElementById("distVal");
    const elAvg = document.getElementById("avgVal");
    const elPts = document.getElementById("ptsVal");
    const elGps = document.getElementById("gpsLabel");
    const elPill = document.getElementById("pillStatus");
    const elAcc = document.getElementById("pillAcc");
    const elRec = document.getElementById("badgeRec");
    const ridesList = document.getElementById("ridesList");

    const btnStart = document.getElementById("btnStart");
    const btnStop = document.getElementById("btnStop");
    const btnCenter = document.getElementById("btnCenter");
    const btnClear = document.getElementById("btnClear");

    // Segments UI refs
    const tabRides = document.getElementById("tabRides");
    const tabSegments = document.getElementById("tabSegments");
    const panelRides = document.getElementById("panelRides");
    const panelSegments = document.getElementById("panelSegments");
    const btnCreateSegment = document.getElementById("btnCreateSegment");
    const btnCancelSegment = document.getElementById("btnCancelSegment");
    const segmentHint = document.getElementById("segmentHint");
    const segmentsList = document.getElementById("segmentsList");

    // ---------- Storage ----------
    function loadRides(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      }catch(e){ return []; }
    }
    function saveRides(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(rides));
    }
    function loadSegments(){
      try{
        const raw = localStorage.getItem(SEGMENTS_KEY);
        return raw ? JSON.parse(raw) : [];
      }catch(e){ return []; }
    }
    function saveSegments(){
      localStorage.setItem(SEGMENTS_KEY, JSON.stringify(segments));
    }

    // ---------- Tabs ----------
    function setTab(tab){
      activeTab = tab;
      if(tab === "rides"){
        panelRides.style.display = "";
        panelSegments.style.display = "none";
        tabRides.classList.add("primary");
        tabSegments.classList.remove("primary");
      }else{
        panelRides.style.display = "none";
        panelSegments.style.display = "";
        tabSegments.classList.add("primary");
        tabRides.classList.remove("primary");
        renderSegments();
      }
    }

    // ---------- Render rides list ----------
    function renderRides(){
      ridesList.innerHTML = "";
      if(!rides.length){
        ridesList.innerHTML = `<div style="color:rgba(234,240,255,.6); font-size:12px;">No rides yet. Record one.</div>`;
        return;
      }
      rides.slice().reverse().forEach((r) => {
        const div = document.createElement("div");
        div.className = "rideItem";
        div.innerHTML = `
          <div class="t">${new Date(r.startedAt).toLocaleString()}</div>
          <div class="m">Dist: ${(r.distanceM/1000).toFixed(2)} km • Time: ${fmtTime(r.durationS)} • Max: ${Math.round(r.maxKmh)} km/h</div>
        `;
        div.onclick = () => showRide(r);
        ridesList.appendChild(div);
      });
    }

    function showRide(r){
      clearMapMarkersOnly();
      const latlngs = r.points.map(p => [p.lat, p.lng]);
      polyline.setLatLngs(latlngs);
      if(latlngs.length){
        map.fitBounds(polyline.getBounds().pad(0.2));
        setMarker(latlngs[latlngs.length-1][0], latlngs[latlngs.length-1][1]);
      }
      elSpeedNow.textContent = "0";
      elSpeedMax.textContent = String(Math.round(r.maxKmh));
      elTime.textContent = fmtTime(r.durationS);
      elDist.textContent = (r.distanceM/1000).toFixed(2) + " km";
      elAvg.textContent = (r.avgKmh).toFixed(0) + " km/h";
      elPts.textContent = String(r.points.length);
      elPill.textContent = "VIEWING";
      elPill.className = "pill good";
      elRec.textContent = "REC: OFF";
    }

    // ---------- Segments ----------
    function renderSegments(){
      segmentsList.innerHTML = "";
      if(!segments.length){
        segmentsList.innerHTML = `<div style="color:rgba(234,240,255,.6); font-size:12px;">No segments yet. Create one.</div>`;
        return;
      }

      segments.slice().reverse().forEach((s) => {
        const best = (s.attempts && s.attempts.length)
          ? s.attempts.slice().sort((a,b)=>a.timeS-b.timeS)[0]
          : null;

        const div = document.createElement("div");
        div.className = "rideItem";
        div.innerHTML = `
          <div class="t">${s.name}</div>
          <div class="m">Radius: ${s.radiusM}m • Attempts: ${(s.attempts?.length||0)} • PB: ${best ? fmtTime(best.timeS) : "—"}</div>
          <hr class="soft"/>
          <div style="display:flex; gap:8px;">
            <button class="smallBtn" data-act="show">SHOW</button>
            <button class="smallBtn" data-act="lb">LEADERBOARD</button>
            <button class="smallBtn" data-act="del" style="border-color: rgba(255,46,136,.45);">DELETE</button>
          </div>
          <div class="m" style="margin-top:8px; display:none;" data-box="lb"></div>
        `;

        div.querySelector('[data-act="show"]').onclick = () => showSegmentOnMap(s);
        div.querySelector('[data-act="del"]').onclick = () => deleteSegment(s.id);
        div.querySelector('[data-act="lb"]').onclick = () => toggleLeaderboard(div, s);

        segmentsList.appendChild(div);
      });
    }

    function showSegmentOnMap(s){
      clearMapMarkersOnly();
      segStartMarker = L.circleMarker([s.start.lat, s.start.lng], { radius: 9, weight: 2, fillOpacity: 0.6 }).addTo(map);
      segEndMarker = L.circleMarker([s.end.lat, s.end.lng], { radius: 9, weight: 2, fillOpacity: 0.6 }).addTo(map);

      const latlngs = polyline.getLatLngs();
      const bounds = L.latLngBounds([ [s.start.lat,s.start.lng], [s.end.lat,s.end.lng] ]);
      if(latlngs.length){
        bounds.extend(polyline.getBounds());
      }
      map.fitBounds(bounds.pad(0.25));

      elPill.textContent = "SEGMENT";
      elPill.className = "pill good";
    }

    function toggleLeaderboard(container, s){
      const box = container.querySelector('[data-box="lb"]');
      const open = box.style.display !== "none";
      if(open){
        box.style.display = "none";
        return;
      }
      const top = (s.attempts||[]).slice().sort((a,b)=>a.timeS-b.timeS).slice(0,10);
      if(!top.length){
        box.innerHTML = `<div style="color:rgba(234,240,255,.6); font-size:12px;">No attempts yet.</div>`;
      }else{
        box.innerHTML = top.map((a,i)=>(
          `<div style="display:flex; justify-content:space-between; font-size:12px; margin:4px 0;">
            <div>${i+1}. ${a.name}</div>
            <div style="font-weight:900;">${fmtTime(a.timeS)}</div>
          </div>`
        )).join("");
      }
      box.style.display = "";
    }

    function deleteSegment(id){
      segments = segments.filter(s => s.id !== id);
      saveSegments();
      renderSegments();
    }

    function clearMapMarkersOnly(){
      if(segStartMarker){ map.removeLayer(segStartMarker); segStartMarker=null; }
      if(segEndMarker){ map.removeLayer(segEndMarker); segEndMarker=null; }
    }

    // Detect segment attempts when a ride is saved
    function detectAttemptsForRide(ride){
      if(!segments.length || !ride.points || ride.points.length < 2) return;

      for(const s of segments){
        const r = s.radiusM ?? 35;

        let startIdx = -1;
        let endIdx = -1;

        for(let i=0;i<ride.points.length;i++){
          const p = ride.points[i];
          const d = haversineMeters({lat:p.lat,lng:p.lng},{lat:s.start.lat,lng:s.start.lng});
          if(d <= r){
            startIdx = i;
            break;
          }
        }
        if(startIdx < 0) continue;

        for(let j=startIdx+1;j<ride.points.length;j++){
          const p = ride.points[j];
          const d = haversineMeters({lat:p.lat,lng:p.lng},{lat:s.end.lat,lng:s.end.lng});
          if(d <= r){
            endIdx = j;
            break;
          }
        }
        if(endIdx < 0) continue;

        const tStart = ride.points[startIdx].t;
        const tEnd = ride.points[endIdx].t;
        const timeS = Math.max(1, Math.round((tEnd - tStart)/1000));

        const attempt = {
          uid: mockUser.uid,
          name: mockUser.name,
          timeS,
          date: Date.now(),
          rideId: ride.id
        };

        s.attempts = s.attempts || [];
        if(!s.attempts.some(a => a.rideId === ride.id)){
          s.attempts.push(attempt);
        }
      }
    }

    // ---------- Recording ----------
    function startRide(){
      if(!navigator.geolocation){
        alert("Este navegador no soporta geolocalización.");
        return;
      }
      recording = true;
      points = [];
      distM = 0;
      maxKmh = 0;
      startTs = Date.now();
      lastPoint = null;

      polyline.setLatLngs([]);
      clearMapMarkersOnly();

      elPill.textContent = "RECORDING";
      elPill.className = "pill good";
      elRec.textContent = "REC: ON";

      btnStart.disabled = true;
      btnStop.disabled = false;

      if(timerId) clearInterval(timerId);
      timerId = setInterval(() => {
        if(!recording) return;
        const sec = (Date.now() - startTs) / 1000;
        elTime.textContent = fmtTime(sec);
        elPts.textContent = String(points.length);
        elDist.textContent = (distM/1000).toFixed(2) + " km";
        const avg = sec > 0 ? (distM/1000) / (sec/3600) : 0;
        elAvg.textContent = avg.toFixed(0) + " km/h";
      }, 250);

      watchId = navigator.geolocation.watchPosition(
        onPos,
        (err) => {
          elPill.textContent = "GPS ERROR";
          elPill.className = "pill bad";
          console.error(err);
        },
        { enableHighAccuracy: true, maximumAge: 1000, timeout: 15000 }
      );
    }

    function stopRide(){
      if(!recording) return;
      recording = false;

      btnStart.disabled = false;
      btnStop.disabled = true;

      elRec.textContent = "REC: OFF";

      if(watchId !== null){
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      if(timerId){
        clearInterval(timerId);
        timerId = null;
      }

      const durationS = Math.max(1, Math.round((Date.now() - startTs)/1000));
      if(points.length >= 2){
        const avgKmh = ((distM/1000) / (durationS/3600));
        const ride = {
          id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
          startedAt: startTs,
          durationS,
          distanceM: distM,
          maxKmh,
          avgKmh,
          points
        };
        rides.push(ride);
        saveRides();
        renderRides();

        // detect segment attempts
        detectAttemptsForRide(ride);
        saveSegments();
        if(activeTab === "segments") renderSegments();

        elPill.textContent = "SAVED";
        elPill.className = "pill good";
      } else {
        elPill.textContent = "NOT SAVED";
        elPill.className = "pill bad";
      }
    }

    function onPos(pos){
      const c = pos.coords;
      const p = {
        t: Date.now(),
        lat: c.latitude,
        lng: c.longitude,
        acc: c.accuracy ?? null,
        spd: c.speed ?? null // m/s
      };

      const acc = typeof p.acc === "number" ? p.acc : null;
      document.getElementById("pillAcc").textContent = "ACC: " + (acc ? (Math.round(acc) + "m") : "—");
      document.getElementById("gpsLabel").textContent = "GPS: " + (acc ? ("±" + Math.round(acc) + "m") : "—");

      if(lastPoint){
        const d = haversineMeters({lat:lastPoint.lat,lng:lastPoint.lng},{lat:p.lat,lng:p.lng});
        if(d < 250) distM += d;
      }
      lastPoint = p;

      points.push(p);

      let kmh = 0;
      if(typeof p.spd === "number" && !Number.isNaN(p.spd)){
        kmh = p.spd * 3.6;
      } else if(points.length >= 2){
        const a = points[points.length-2];
        const b = points[points.length-1];
        const dt = Math.max(0.5, (b.t - a.t)/1000);
        const d = haversineMeters({lat:a.lat,lng:a.lng},{lat:b.lat,lng:b.lng});
        kmh = (d/dt) * 3.6;
      }
      kmh = clamp(kmh, 0, 320);

      elSpeedNow.textContent = String(Math.round(kmh));
      if(kmh > maxKmh){
        maxKmh = kmh;
        elSpeedMax.textContent = String(Math.round(maxKmh));
      }

      polyline.addLatLng([p.lat, p.lng]);
      setMarker(p.lat, p.lng);
    }

    function setMarker(lat,lng){
      if(!marker){
        marker = L.circleMarker([lat,lng], { radius: 8, weight: 2, opacity: 0.9, fillOpacity: 0.6 }).addTo(map);
      } else {
        marker.setLatLng([lat,lng]);
      }
    }

    // ---------- Buttons ----------
    btnStart.onclick = startRide;
    btnStop.onclick = stopRide;

    btnCenter.onclick = () => {
      const ll = polyline.getLatLngs();
      if(ll.length) map.fitBounds(polyline.getBounds().pad(0.25));
    };

    btnClear.onclick = () => {
      polyline.setLatLngs([]);
      if(marker){ map.removeLayer(marker); marker = null; }
      clearMapMarkersOnly();
      elPill.textContent = "READY";
      elPill.className = "pill good";
      elSpeedNow.textContent = "0";
      elSpeedMax.textContent = "0";
      elTime.textContent = "00:00";
      elDist.textContent = "0.00 km";
      elAvg.textContent = "0 km/h";
      elPts.textContent = "0";
    };

    // ---------- Segment creation ----------
    tabRides.onclick = () => setTab("rides");
    tabSegments.onclick = () => setTab("segments");

    btnCreateSegment.onclick = () => {
      creatingSegment = true;
      createStage = 1;
      segStart = null;
      segEnd = null;
      clearMapMarkersOnly();
      segmentHint.textContent = "Click START point on the map…";
    };

    btnCancelSegment.onclick = () => {
      creatingSegment = false;
      createStage = 0;
      segStart = null;
      segEnd = null;
      clearMapMarkersOnly();
      segmentHint.textContent = "Tip: CREATE SEGMENT → click Start en el mapa → click End en el mapa.";
    };

    map.on("click", (e) => {
      if(!creatingSegment) return;

      if(createStage === 1){
        segStart = { lat: e.latlng.lat, lng: e.latlng.lng };
        if(segStartMarker) map.removeLayer(segStartMarker);
        segStartMarker = L.circleMarker([segStart.lat, segStart.lng], { radius: 10, weight: 2, fillOpacity: 0.65 }).addTo(map);
        createStage = 2;
        segmentHint.textContent = "Now click END point on the map…";
        return;
      }

      if(createStage === 2){
        segEnd = { lat: e.latlng.lat, lng: e.latlng.lng };
        if(segEndMarker) map.removeLayer(segEndMarker);
        segEndMarker = L.circleMarker([segEnd.lat, segEnd.lng], { radius: 10, weight: 2, fillOpacity: 0.65 }).addTo(map);

        const name = prompt("Segment name:", "MY SEGMENT") || "MY SEGMENT";
        const radiusM = 35;

        const seg = {
          id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())),
          name: name.toUpperCase(),
          vehicleType: "both",
          radiusM,
          start: segStart,
          end: segEnd,
          attempts: []
        };

        segments.push(seg);
        saveSegments();
        renderSegments();

        creatingSegment = false;
        createStage = 0;
        segmentHint.textContent = "Segment saved. Record a ride to generate attempts.";

        elPill.textContent = "SEGMENT SAVED";
        elPill.className = "pill good";
      }
    });

    // ---------- Init ----------
    renderRides();
    renderSegments();
    setTab("rides");
  </script>
</body>
</html>
